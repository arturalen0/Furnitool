<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Couch AR Viewer</title>
    <script
      type="module"
      src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"
    ></script>
    <!-- Three.js for material manipulation -->
    <script type="importmap">
      {
        "imports": {
          "three": "https://unpkg.com/three@0.160.0/build/three.module.js"
        }
      }
    </script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        background: #000;
        overflow: hidden;
      }

      model-viewer {
        width: 100vw;
        height: 100vh;
        background-color: transparent;
      }

      #config-info {
        position: fixed;
        top: 20px;
        left: 20px;
        right: 20px;
        background: rgba(0, 0, 0, 0.8);
        color: white;
        padding: 15px;
        border-radius: 12px;
        backdrop-filter: blur(10px);
        z-index: 100;
        text-align: center;
      }

      #config-info h2 {
        font-size: 18px;
        margin-bottom: 10px;
      }

      #config-info p {
        font-size: 14px;
        opacity: 0.9;
        margin: 5px 0;
      }

      .ar-button {
        position: fixed;
        bottom: 30px;
        left: 50%;
        transform: translateX(-50%);
        background: #007aff;
        color: white;
        border: none;
        padding: 16px 32px;
        border-radius: 25px;
        font-size: 16px;
        font-weight: 600;
        cursor: pointer;
        box-shadow: 0 4px 20px rgba(0, 122, 255, 0.4);
        transition: all 0.3s ease;
        z-index: 100;
      }

      .ar-button:hover {
        background: #0056cc;
        transform: translateX(-50%) translateY(-2px);
        box-shadow: 0 6px 25px rgba(0, 122, 255, 0.5);
      }

      .ar-button:active {
        transform: translateX(-50%) translateY(0px);
      }

      #loading {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: white;
        text-align: center;
        z-index: 50;
      }

      .spinner {
        width: 40px;
        height: 40px;
        border: 4px solid rgba(255, 255, 255, 0.3);
        border-top: 4px solid white;
        border-radius: 50%;
        animation: spin 1s linear infinite;
        margin: 0 auto 15px;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .feature-buttons {
        position: fixed;
        top: 20px;
        right: 20px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        z-index: 100;
      }

      .feature-btn {
        background: rgba(255, 255, 255, 0.9);
        border: none;
        padding: 10px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 12px;
        font-weight: 600;
        min-width: 80px;
        backdrop-filter: blur(10px);
        transition: all 0.3s ease;
      }

      .feature-btn:hover {
        background: rgba(255, 255, 255, 1);
        transform: scale(1.05);
      }
    </style>
  </head>
  <body>
    <div id="loading">
      <div class="spinner"></div>
      <p>Loading your configured couch...</p>
    </div>

    <div id="config-info" style="display: none">
      <h2>Your Configured Couch</h2>
      <p id="fabric-info">Fabric: Loading...</p>
      <p id="stitch-info">Stitch: Loading...</p>
      <p id="legs-info">Legs: Loading...</p>
    </div>

    <model-viewer
      id="couch-ar-viewer"
      src="couch.glb"
      alt="Configured Couch in AR"
      ar
      ar-modes="webxr scene-viewer quick-look"
      ar-scale="auto"
      camera-controls
      auto-rotate
      shadow-intensity="1"
      shadow-softness="0.5"
      exposure="1"
      environment-image="neutral"
      camera-orbit="45deg 75deg 2.5m"
      min-camera-orbit="auto auto 1m"
      max-camera-orbit="auto auto 6m"
      interaction-prompt="auto"
      loading="eager"
      reveal="auto"
    >
      <button slot="ar-button" class="ar-button">üëÅÔ∏è View in AR</button>
    </model-viewer>

    <div class="feature-buttons">
      <button class="feature-btn" onclick="toggleAutoRotate()">‚ü≤ Rotate</button>
      <button class="feature-btn" onclick="resetView()">üéØ Reset</button>
      <button class="feature-btn" onclick="shareConfig()">üì§ Share</button>
    </div>

    <script>
      const modelViewer = document.getElementById("couch-ar-viewer");
      const loadingDiv = document.getElementById("loading");
      const configInfo = document.getElementById("config-info");

      // Parse URL parameters to get configuration
      const urlParams = new URLSearchParams(window.location.search);
      const config = {
        fabric: urlParams.get("fabric") || "Cloud",
        stitch: urlParams.get("stitch") || "Cloud",
        legs: urlParams.get("legs") || "Rosewood Veneer",
      };

      // Update configuration display
      document.getElementById(
        "fabric-info"
      ).textContent = `Fabric: ${config.fabric}`;
      document.getElementById(
        "stitch-info"
      ).textContent = `Stitch: ${config.stitch}`;
      document.getElementById("legs-info").textContent = `Legs: ${config.legs}`;

      // Show configuration info
      configInfo.style.display = "block";

      // Handle model loading
      modelViewer.addEventListener("load", () => {
        console.log("AR model loaded with config:", config);
        loadingDiv.style.display = "none";

        // Apply configuration (in a real implementation, you'd modify materials here)
        applyConfiguration(config);
      });

      modelViewer.addEventListener("error", (error) => {
        console.error("Model loading error:", error);
        loadingDiv.innerHTML =
          '<p style="color: red;">Failed to load 3D model</p>';
      });

      async function applyConfiguration(config) {
        console.log("Applying configuration:", config);

        try {
          // Wait for model-viewer to be ready
          await modelViewer.updateComplete;

          // Access the Three.js scene from model-viewer
          const scene = modelViewer.model;
          if (!scene) {
            console.warn("Model not loaded yet, retrying...");
            setTimeout(() => applyConfiguration(config), 1000);
            return;
          }

          // Import Three.js dynamically
          const THREE = await import("three");
          const textureLoader = new THREE.TextureLoader();

          // Material configuration mapping
          const fabricTextures = {
            Cloud:
              "textures/fabrics/twinbru_Sabato_28-Cloud_78bc31df720040f98507df3a952a4264/",
            Limestone:
              "textures/fabrics/twinbru_Sabato_01-Limestone_dcdf6528525142e98efbccff9cd72c74/",
            Flax: "textures/fabrics/twinbru_Sabato_06-Flax_7932749150ae466099eb91ff8fc2909c/",
            Bonbon:
              "textures/fabrics/twinbru_Sabato_17-Bonbon_5f4a348fcb2444bb91a9fcb93c3de7c6/",
            "Rough Sofa Fabric": "textures/fabrics/rough-sofa-fabric-bl/",
          };

          const legTextures = {
            "Rosewood Veneer": "textures/legs/rosewood_veneer1_4k.blend/",
            "Polished Metal": "textures/legs/PolishedMetal/",
          };

          // Find and update materials
          scene.traverse((child) => {
            if (child.isMesh) {
              const meshName = child.name.toLowerCase();

              // Apply fabric materials to body and plane meshes
              if (meshName.includes("body") || meshName.includes("plane")) {
                const fabricPath = fabricTextures[config.fabric];
                if (fabricPath) {
                  updateMeshMaterial(child, fabricPath, textureLoader, THREE);
                }
              }

              // Apply stitch materials
              else if (meshName.includes("stitch")) {
                const stitchPath = fabricTextures[config.stitch];
                if (stitchPath) {
                  updateMeshMaterial(child, stitchPath, textureLoader, THREE);
                }
              }

              // Apply leg materials
              else if (meshName.includes("legs")) {
                const legPath = legTextures[config.legs];
                if (legPath) {
                  updateMeshMaterial(child, legPath, textureLoader, THREE);
                }
              }
            }
          });

          console.log("Materials applied successfully!");
        } catch (error) {
          console.error("Error applying configuration:", error);
        }
      }

      function updateMeshMaterial(mesh, texturePath, textureLoader, THREE) {
        try {
          // Create new PBR material
          const material = new THREE.MeshStandardMaterial();

          // Load textures based on available files
          const baseUrl = window.location.origin + "/";

          // Try to load color texture
          if (texturePath.includes("rough-sofa-fabric-bl")) {
            // Handle the PNG-based texture set
            textureLoader.load(
              baseUrl + texturePath + "rough-sofa-fabric_albedo.png",
              (texture) => {
                texture.wrapS = texture.wrapT = THREE.RepeatWrapping;
                texture.repeat.set(0.06, 0.06);
                texture.flipY = false;
                material.map = texture;
                mesh.material = material;
              }
            );

            textureLoader.load(
              baseUrl + texturePath + "rough-sofa-fabric_roughness.png",
              (texture) => {
                texture.wrapS = texture.wrapT = THREE.RepeatWrapping;
                texture.repeat.set(0.06, 0.06);
                texture.flipY = false;
                material.roughnessMap = texture;
              }
            );

            textureLoader.load(
              baseUrl + texturePath + "rough-sofa-fabric_normal-ogl.png",
              (texture) => {
                texture.wrapS = texture.wrapT = THREE.RepeatWrapping;
                texture.repeat.set(0.06, 0.06);
                texture.flipY = false;
                material.normalMap = texture;
              }
            );
          } else if (texturePath.includes("rosewood_veneer1_4k.blend")) {
            // Handle the wood texture
            textureLoader.load(
              baseUrl + texturePath + "rosewood_veneer1_diff_4k.jpg",
              (texture) => {
                texture.wrapS = texture.wrapT = THREE.RepeatWrapping;
                texture.repeat.set(0.06, 0.06);
                texture.flipY = false;
                material.map = texture;
                mesh.material = material;
              }
            );
          } else {
            // Handle the standard JPG-based texture sets
            const suffix = texturePath
              .split("/")
              .pop()
              .replace(/[^a-zA-Z0-9]/g, "_");

            textureLoader.load(
              baseUrl + texturePath + suffix + "_col.jpg",
              (texture) => {
                texture.wrapS = texture.wrapT = THREE.RepeatWrapping;
                texture.repeat.set(0.06, 0.06);
                texture.flipY = false;
                material.map = texture;
                mesh.material = material;
              }
            );

            textureLoader.load(
              baseUrl + texturePath + suffix + "_rough.jpg",
              (texture) => {
                texture.wrapS = texture.wrapT = THREE.RepeatWrapping;
                texture.repeat.set(0.06, 0.06);
                texture.flipY = false;
                material.roughnessMap = texture;
              }
            );

            textureLoader.load(
              baseUrl + texturePath + suffix + "_nrm.jpg",
              (texture) => {
                texture.wrapS = texture.wrapT = THREE.RepeatWrapping;
                texture.repeat.set(0.06, 0.06);
                texture.flipY = false;
                material.normalMap = texture;
              }
            );
          }
        } catch (error) {
          console.error("Error updating mesh material:", error);
        }
      }

      function toggleAutoRotate() {
        modelViewer.autoRotate = !modelViewer.autoRotate;
      }

      function resetView() {
        modelViewer.cameraOrbit = "45deg 75deg 2.5m";
        modelViewer.fieldOfView = "45deg";
      }

      function shareConfig() {
        if (navigator.share) {
          navigator.share({
            title: "Check out this couch configuration!",
            text: `Fabric: ${config.fabric}, Stitch: ${config.stitch}, Legs: ${config.legs}`,
            url: window.location.href,
          });
        } else {
          // Fallback: copy to clipboard
          navigator.clipboard.writeText(window.location.href).then(() => {
            alert("Configuration link copied to clipboard!");
          });
        }
      }

      // Auto-hide config info after 5 seconds
      setTimeout(() => {
        configInfo.style.opacity = "0";
        configInfo.style.transition = "opacity 0.5s ease";
      }, 5000);

      // Show config info on tap
      document.addEventListener("click", () => {
        if (configInfo.style.opacity === "0") {
          configInfo.style.opacity = "1";
          setTimeout(() => {
            configInfo.style.opacity = "0";
          }, 3000);
        }
      });
    </script>
  </body>
</html>
